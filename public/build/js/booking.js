document.addEventListener("DOMContentLoaded",()=>{const e=document.querySelectorAll("[data-service-id]"),t=document.querySelectorAll("[data-barber-id]"),n=document.getElementById("input-fecha"),r=document.getElementById("times-container"),a=document.getElementById("next-btn"),d=document.getElementById("back-btn"),i=document.getElementById("mini-servicio"),s=document.getElementById("mini-barbero"),c=document.getElementById("mini-fecha"),l=document.getElementById("mini-hora"),o=document.getElementById("duracion-label"),m=document.getElementById("selected-barbero-label"),b=document.getElementById("conf-servicio"),u=document.getElementById("conf-barbero"),v=document.getElementById("conf-fecha"),p=document.getElementById("conf-hora");let g={step:1,service:null,barber:null,date:null,start:null,name:""};function E(e){for(let t=1;t<=4;t++){const n=document.getElementById("step-"+t);n&&(n.style.display=t===e?"block":"none")}g.step=e,d.disabled=1===e,a.innerText=4===e?"Confirmar":"Siguiente",h()}function h(){1===g.step?a.disabled=!(g.service&&g.barber):2===g.step?a.disabled=!g.date:3===g.step?a.disabled=!g.start:a.disabled=!1}function y(e){E(e),3===e&&f(),4===e&&(b.innerText=g.service?g.service.name:"-",u.innerText=g.barber?g.barber.name:"-",v.innerText=g.date||"-",p.innerText=g.start?g.start.substr(0,5):"-")}function f(){if(!g.date||!g.barber||!g.service){if(r.innerHTML='<div class="muted">Eleg√≠ servicio, barbero y fecha</div>',g.barber&&!g.date){const e=(new Date).toISOString().slice(0,10);!function(e,t,n=null){const r=new FormData;r.append("date",t),r.append("barber_id",e),n&&r.append("service_id",n),fetch("/booking/slots",{method:"POST",body:r}).then(e=>e.json()).then(e=>{const t=document.getElementById("interval-label");e&&void 0!==e.base&&null!==e.base?t.innerText=e.base+" min":t.innerText="‚Äî"}).catch(()=>{document.getElementById("interval-label").innerText="‚Äî"})}(g.barber.id,e,g.service?g.service.id:null)}else document.getElementById("interval-label").innerText="‚Äî";return}const e=new FormData;e.append("date",g.date),e.append("barber_id",g.barber.id),e.append("service_id",g.service.id),r.innerHTML="Cargando...",fetch("/booking/slots",{method:"POST",body:e}).then(e=>e.json()).then(e=>{const t=document.getElementById("interval-label");var n;(e&&void 0!==e.base&&null!==e.base?t.innerText=e.base+" min":t.innerText="‚Äî",!e.message||e.intervals&&0!==e.intervals.length)?(n=e.intervals||[],r.innerHTML="",g.start=null,l.innerText="-",n.forEach(e=>{const t=document.createElement("button");t.type="button",t.className="time-btn"+(e.available?"":" disabled");const n=(e.start||"").length>=5?e.start.substr(0,5):e.start,a=(e.end||"").length>=5?e.end.substr(0,5):e.end;t.innerText=n+" - "+a,e.available&&t.addEventListener("click",()=>{document.querySelectorAll(".time-btn").forEach(e=>e.classList.remove("selected")),t.classList.add("selected"),g.start=e.start,l.innerText=n,h()}),r.appendChild(t)})):r.innerHTML='<div class="muted">'+(e.message||"No hay horarios")+"</div>"}).catch(()=>{r.innerHTML='<div class="muted">Error al cargar horarios</div>',document.getElementById("interval-label").innerText="‚Äî"})}e.forEach(t=>{t.addEventListener("click",()=>{e.forEach(e=>e.classList.remove("selected")),t.classList.add("selected");const n=parseInt(t.dataset.serviceId,10),r=t.querySelector("strong")?t.querySelector("strong").innerText.trim():"",a=parseInt(t.dataset.duracion||"30",10),d=t.dataset.precio||"";g.service={id:n,name:r,duration:a,price:d},i.innerText=r,o.innerText=a+" min",h()})}),t.forEach(e=>{e.addEventListener("click",()=>{t.forEach(e=>e.classList.remove("selected")),e.classList.add("selected");const n=parseInt(e.dataset.barberId,10),r=e.dataset.nombre||(e.querySelector("strong")?e.querySelector("strong").innerText.trim():"");g.barber={id:n,name:r},s.innerText=r,m.innerText=r,h()})}),d.addEventListener("click",()=>{g.step>1&&y(g.step-1)}),a.addEventListener("click",()=>{if(g.step<4)return 1!==g.step||g.service&&g.barber?2!==g.step||g.date?3!==g.step||g.start?void y(g.step+1):alert("Eleg√≠ un horario"):alert("Eleg√≠ una fecha"):alert("Eleg√≠ servicio y barbero");const e=document.getElementById("input-nombre").value.trim();if(!e)return alert("Ingres√° tu nombre");g.name=e;const t=new FormData;t.append("date",g.date),t.append("barber_id",g.barber.id),t.append("service_id",g.service.id),t.append("start",function(e){if(!e)return"";const t=e.split(":").map(e=>e.trim());return 2===t.length?`${t[0].padStart(2,"0")}:${t[1].padStart(2,"0")}:00`:3===t.length?`${t[0].padStart(2,"0")}:${t[1].padStart(2,"0")}:${t[2].padStart(2,"0")}`:e}(g.start)),window.__BOOKING_DATA&&window.__BOOKING_DATA.test_client_id&&t.append("client_id",window.__BOOKING_DATA.test_client_id),t.append("name",g.name),a.disabled=!0,fetch("/booking/reserve",{method:"POST",body:t}).then(async e=>{if(a.disabled=!1,!e.ok){let t={};try{t=await e.json()}catch(e){}return alert(t.error||"Error al reservar")}const t=await e.json();alert("Reserva confirmada üëç (cita_id: "+(t.cita_id||"-")+")"),window.location.reload()}).catch(()=>{a.disabled=!1,alert("Error de conexi√≥n")})}),n&&n.addEventListener("change",e=>{g.date=e.target.value,c.innerText=g.date||"-",h(),g.service&&g.barber&&f()}),E(1)});