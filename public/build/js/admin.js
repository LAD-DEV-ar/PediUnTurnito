document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll(".admin-tab").forEach(e=>{e.addEventListener("click",()=>{document.querySelectorAll(".admin-section").forEach(e=>e.style.display="none");const t=e.dataset.tab,r=document.getElementById("tab-"+t);r&&(r.style.display="block"),"barberias"===t&&n(),"servicios"===t&&o(),"horarios"===t&&d(),"barberos"===t&&l(),"turnos"===t&&s(),"citas"===t&&u()})}),document.querySelector(".admin-tab")?.click();const e=document.getElementById("barberias-list"),t=document.getElementById("barberia-form-wrap");function n(){e.innerHTML="Cargando...",fetch("/admin/barberia/list",{method:"POST"}).then(e=>e.json()).then(t=>{e.innerHTML="",(t.items||[]).forEach(t=>{const n=document.createElement("div");n.className="item",n.innerHTML=`<div style="flex:1"><strong>${h(t.nombre)}</strong><div class="mini">${h(t.localidad||"")} — ${h((t.calle||"")+" "+(t.altura||""))}</div></div>\n          <div style="display:flex;gap:8px">\n            <button class="btn ghost btn-edit-barberia" data-id="${t.id}">Editar</button>\n            <button class="btn ghost btn-delete-barberia" data-id="${t.id}">Eliminar</button>\n          </div>`,e.appendChild(n)}),document.querySelectorAll(".btn-edit-barberia").forEach(e=>e.addEventListener("click",t=>{!function(e){fetch("/admin/barberia/list",{method:"POST"}).then(e=>e.json()).then(t=>{const n=(t.items||[]).find(t=>String(t.id)===String(e));n&&r(n)})}(e.dataset.id)})),document.querySelectorAll(".btn-delete-barberia").forEach(e=>e.addEventListener("click",t=>{if(!confirm("Eliminar barbería?"))return;const r=new FormData;r.append("id",e.dataset.id),fetch("/admin/barberia/delete",{method:"POST",body:r}).then(e=>e.json()).then(e=>{if(e.error)return alert(e.error);n(),v()})}))}).catch(()=>e.innerHTML="Error al cargar")}function r(e=null){document.getElementById("barberia-form-wrap").style.display="block",document.getElementById("barberia-id").value=e?e.id:"",document.getElementById("barberia-nombre").value=e?e.nombre:"",document.getElementById("barberia-localidad").value=e?e.localidad:"",document.getElementById("barberia-calle").value=e?e.calle:"",document.getElementById("barberia-altura").value=e?e.altura:"",document.getElementById("barberia-form-title").innerText=e?"Editar barbería":"Nueva barbería"}document.getElementById("btn-new-barberia").addEventListener("click",()=>{r()}),document.getElementById("barberia-cancel").addEventListener("click",e=>{t.style.display="none"}),document.getElementById("barberia-save").addEventListener("click",()=>{const e=document.getElementById("barberia-id").value,r=document.getElementById("barberia-nombre").value,a=document.getElementById("barberia-localidad").value,o=document.getElementById("barberia-calle").value,i=document.getElementById("barberia-altura").value,d=new FormData;e&&d.append("id",e),d.append("nombre",r),d.append("localidad",a),d.append("calle",o),d.append("altura",i),fetch("/admin/barberia/save",{method:"POST",body:d}).then(e=>e.json()).then(e=>{if(e.error)return alert(e.error);t.style.display="none",n(),v()}).catch(()=>alert("Error al guardar"))});const a=document.getElementById("servicios-list");function o(){a.innerHTML="Cargando...";const e=(document.getElementById("servicios-barberia-filter")||{}).value||"",t=new FormData;e&&t.append("id_barberia",e),console.debug("[loadServicios] id_barberia=",e),fetch("/admin/servicio/list",{method:"POST",body:t}).then(e=>e.json()).then(e=>{a.innerHTML="";const t=e.items||[];0!==t.length?(t.forEach(e=>{const t=document.createElement("div");t.className="item",t.innerHTML=`<div style="flex:1"><strong>${h(e.nombre)}</strong><div class="mini">${e.duracion_min} min · $${e.precio}</div></div>\n            <div style="display:flex;gap:8px">\n              <button class="btn ghost btn-edit-servicio" data-id="${e.id}">Editar</button>\n              <button class="btn ghost btn-delete-servicio" data-id="${e.id}">Eliminar</button>\n            </div>`,a.appendChild(t)}),document.querySelectorAll(".btn-edit-servicio").forEach(e=>e.addEventListener("click",t=>{return n=e.dataset.id,void fetch("/admin/servicio/list",{method:"POST"}).then(e=>e.json()).then(e=>{const t=(e.items||[]).find(e=>String(e.id)===String(n));if(!t)return alert("Servicio no encontrado");document.getElementById("servicio-id").value=t.id,v(),setTimeout(()=>{const e=document.getElementById("servicio-barberia");e&&(e.value=t.id_barberia||""),document.getElementById("servicio-nombre").value=t.nombre||"",document.getElementById("servicio-duracion").value=t.duracion_min||"",document.getElementById("servicio-precio").value=t.precio||"",document.getElementById("servicio-form-wrap").style.display="block"},150)}).catch(e=>{console.error("editServicio error",e),alert("Error al obtener servicio")});var n})),document.querySelectorAll(".btn-delete-servicio").forEach(e=>e.addEventListener("click",t=>{if(!confirm("Eliminar servicio?"))return;const n=new FormData;n.append("id",e.dataset.id),fetch("/admin/servicio/delete",{method:"POST",body:n}).then(()=>o())}))):a.innerHTML='<div class="muted">No hay servicios.</div>'}).catch(e=>{console.error("loadServicios error",e),a.innerHTML="Error al cargar servicios"})}document.getElementById("btn-new-servicio").addEventListener("click",()=>{document.getElementById("servicio-form-wrap").style.display="block",v()}),document.getElementById("servicio-cancel").addEventListener("click",()=>document.getElementById("servicio-form-wrap").style.display="none"),document.getElementById("servicio-save").addEventListener("click",()=>{const e=document.getElementById("servicio-id").value,t=document.getElementById("servicio-barberia").value,n=document.getElementById("servicio-nombre").value,r=document.getElementById("servicio-duracion").value,a=document.getElementById("servicio-precio").value,i=new FormData;e&&i.append("id",e),i.append("id_barberia",t),i.append("nombre",n),i.append("duracion_min",r),i.append("precio",a),fetch("/admin/servicio/save",{method:"POST",body:i}).then(e=>e.json()).then(e=>{if(e.error)return alert(e.error);document.getElementById("servicio-form-wrap").style.display="none",o()}).catch(()=>alert("Error"))});const i=document.getElementById("horarios-list");function d(){i.innerHTML="Cargando...";const e=document.getElementById("horarios-barberia-filter").value||"",t=new FormData;e&&t.append("id_barberia",e),fetch("/admin/horario/list",{method:"POST",body:t}).then(e=>e.json()).then(e=>{i.innerHTML="",(e.items||[]).forEach(e=>{const t=document.createElement("div");t.className="item",t.innerHTML=`<div style="flex:1"><strong>${h(e.dia_semana)}</strong><div class="mini">${e.hora_apertura} — ${e.hora_cierre} · ${e.intervalo_min} min</div></div>\n          <div style="display:flex;gap:8px">\n            <button class="btn ghost btn-edit-horario" data-id="${e.id}">Editar</button>\n            <button class="btn ghost btn-delete-horario" data-id="${e.id}">Eliminar</button>\n          </div>`,i.appendChild(t)}),document.querySelectorAll(".btn-edit-horario").forEach(e=>e.addEventListener("click",t=>function(e){const t=new FormData;t.append("id_barberia",""),fetch("/admin/horario/list",{method:"POST",body:t}).then(e=>e.json()).then(t=>{const n=(t.items||[]).find(t=>String(t.id)===String(e));if(!n)return alert("No encontrado");document.getElementById("horario-id").value=n.id,v(),setTimeout(()=>{document.getElementById("horario-barberia").value=n.id_barberia,document.getElementById("horario-dia").value=n.dia_semana,document.getElementById("horario-apertura").value=n.hora_apertura,document.getElementById("horario-cierre").value=n.hora_cierre,document.getElementById("horario-intervalo").value=n.intervalo_min,document.getElementById("horario-form-wrap").style.display="block"},200)})}(e.dataset.id))),document.querySelectorAll(".btn-delete-horario").forEach(e=>e.addEventListener("click",t=>{if(!confirm("Eliminar horario?"))return;const n=new FormData;n.append("id",e.dataset.id),fetch("/admin/horario/delete",{method:"POST",body:n}).then(e=>e.json()).then(e=>d())}))}).catch(()=>i.innerHTML="Error")}document.getElementById("btn-new-horario").addEventListener("click",()=>{document.getElementById("horario-form-wrap").style.display="block",v()}),document.getElementById("horario-cancel").addEventListener("click",()=>document.getElementById("horario-form-wrap").style.display="none"),document.getElementById("horario-save").addEventListener("click",()=>{const e=new FormData,t=document.getElementById("horario-id").value;t&&e.append("id",t),e.append("id_barberia",document.getElementById("horario-barberia").value),e.append("dia_semana",document.getElementById("horario-dia").value),e.append("hora_apertura",document.getElementById("horario-apertura").value),e.append("hora_cierre",document.getElementById("horario-cierre").value),e.append("intervalo_min",document.getElementById("horario-intervalo").value),fetch("/admin/horario/save",{method:"POST",body:e}).then(e=>e.json()).then(e=>{if(e.error)return alert(e.error);document.getElementById("horario-form-wrap").style.display="none",d()}).catch(()=>alert("Error"))});const c=document.getElementById("barberos-list");function l(){c.innerHTML="Cargando...";const e=document.getElementById("barberos-barberia-filter").value||"",t=new FormData;e&&t.append("id_barberia",e),fetch("/admin/barbero/list",{method:"POST",body:t}).then(e=>e.json()).then(e=>{c.innerHTML="",(e.items||[]).forEach(e=>{const t=document.createElement("div");t.className="item",t.innerHTML=`<div style="flex:1"><strong>${h(e.nombre)}</strong><div class="mini">${h(e.email||"")} · ${h(e.telefono||"")}</div></div>\n          <div style="display:flex;gap:8px">\n            <button class="btn ghost btn-edit-barbero" data-id="${e.id}">Editar</button>\n            <button class="btn ghost btn-delete-barbero" data-id="${e.id}">Eliminar</button>\n          </div>`,c.appendChild(t)}),document.querySelectorAll(".btn-edit-barbero").forEach(e=>e.addEventListener("click",t=>function(e){const t=new FormData;t.append("id_barberia",""),fetch("/admin/barbero/list",{method:"POST",body:t}).then(e=>e.json()).then(t=>{const n=(t.items||[]).find(t=>String(t.id)===String(e));if(!n)return alert("No encontrado");v(),setTimeout(()=>{document.getElementById("barbero-id").value=n.id,document.getElementById("barbero-barberia").value=n.id_barberia,document.getElementById("barbero-nombre").value=n.nombre,document.getElementById("barbero-email").value=n.email,document.getElementById("barbero-telefono").value=n.telefono,document.getElementById("barbero-form-wrap").style.display="block"},200)})}(e.dataset.id))),document.querySelectorAll(".btn-delete-barbero").forEach(e=>e.addEventListener("click",t=>{if(!confirm("Eliminar barbero?"))return;const n=new FormData;n.append("id",e.dataset.id),fetch("/admin/barbero/delete",{method:"POST",body:n}).then(e=>e.json()).then(e=>l())}))}).catch(()=>c.innerHTML="Error")}document.getElementById("btn-new-barbero").addEventListener("click",()=>{document.getElementById("barbero-form-wrap").style.display="block",v()}),document.getElementById("barbero-cancel").addEventListener("click",()=>document.getElementById("barbero-form-wrap").style.display="none"),document.getElementById("barbero-save").addEventListener("click",()=>{const e=new FormData,t=document.getElementById("barbero-id").value;t&&e.append("id",t),e.append("id_barberia",document.getElementById("barbero-barberia").value),e.append("nombre",document.getElementById("barbero-nombre").value),e.append("email",document.getElementById("barbero-email").value),e.append("telefono",document.getElementById("barbero-telefono").value),e.append("password",document.getElementById("barbero-password").value),fetch("/admin/barbero/save",{method:"POST",body:e}).then(e=>e.json()).then(e=>{if(e.error)return alert(e.error);document.getElementById("barbero-form-wrap").style.display="none",l()}).catch(()=>alert("Error"))});const m=document.getElementById("turnos-list");function s(){m.innerHTML="Cargando...";const e=new FormData,t=document.getElementById("turnos-barberia-filter").value;t&&e.append("id_barberia",t);const n=document.getElementById("turnos-barbero-filter").value;n&&e.append("id_barbero",n);const r=document.getElementById("turnos-fecha-filter").value;r&&e.append("fecha",r),fetch("/admin/turnos/list",{method:"POST",body:e}).then(e=>e.json()).then(e=>{m.innerHTML="",(e.items||[]).forEach(e=>{const t=document.createElement("div");t.className="item",t.innerHTML=`<div style="flex:1"><strong>${e.fecha} ${e.hora_inicio}</strong><div class="mini">Barbero: ${h(String(e.id_barbero))} · Estado: ${h(e.estado)}</div></div>\n          <div style="display:flex;gap:8px">\n            <button class="btn ghost btn-mark-free" data-id="${e.id}">Marcar libre</button>\n            <button class="btn ghost btn-mark-reserved" data-id="${e.id}">Marcar reservado</button>\n          </div>`,m.appendChild(t)}),document.querySelectorAll(".btn-mark-free").forEach(e=>e.addEventListener("click",()=>{if(!confirm("Marcar este turno como libre?"))return;const t=new FormData;t.append("id",e.dataset.id),t.append("estado","libre"),fetch("/admin/turnos/update",{method:"POST",body:t}).then(()=>s()).catch(()=>alert("Error"))})),document.querySelectorAll(".btn-mark-reserved").forEach(e=>e.addEventListener("click",()=>{if(!confirm("Marcar este turno como reservado?"))return;const t=new FormData;t.append("id",e.dataset.id),t.append("estado","reservado"),fetch("/admin/turnos/update",{method:"POST",body:t}).then(()=>s()).catch(()=>alert("Error"))}))}).catch(()=>m.innerHTML="Error")}document.getElementById("turnos-refresh").addEventListener("click",s);const b=document.getElementById("citas-list");function u(){b.innerHTML="Cargando...",fetch("/admin/cita/list",{method:"POST"}).then(e=>e.json()).then(e=>{b.innerHTML="",(e.items||[]).forEach(e=>{const t=document.createElement("div");t.className="item",t.innerHTML=`<div style="flex:1"><strong>${h(e.servicio_nombre||"Servicio")}</strong><div class="mini">${h(e.cliente_nombre||"")} — ${h(e.fecha||"")} ${h(e.hora_inicio||"")}</div></div>\n          <div style="display:flex;gap:8px">\n            <button class="btn ghost btn-cancel-cita" data-id="${e.id}">Cancelar</button>\n          </div>`,b.appendChild(t)}),document.querySelectorAll(".btn-cancel-cita").forEach(e=>e.addEventListener("click",()=>{if(!confirm("Cancelar cita?"))return;const t=new FormData;t.append("id",e.dataset.id),fetch("/admin/cita/cancel",{method:"POST",body:t}).then(e=>e.json()).then(e=>{if(e.error)return alert(e.error);u(),s(),n()})}))}).catch(()=>b.innerHTML="Error")}function h(e){return e?String(e).replace(/[&<>"']/g,e=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[e])):""}function v(){fetch("/admin/barberia/list",{method:"POST"}).then(e=>e.json()).then(e=>{const t=e.items||[];[document.getElementById("servicio-barberia"),document.getElementById("servicios-barberia-filter"),document.getElementById("horario-barberia"),document.getElementById("horarios-barberia-filter"),document.getElementById("barbero-barberia"),document.getElementById("barberos-barberia-filter"),document.getElementById("turnos-barberia-filter")].forEach(e=>{if(!e)return;const n="servicios-barberia-filter"===e.id?"Todas las barberías":"Seleccione";e.innerHTML=`<option value="">${n}</option>`,t.forEach(t=>{const n=document.createElement("option");n.value=t.id,n.textContent=t.nombre,e.appendChild(n)})})}).catch(e=>{console.error("populateBarberiaSelects error",e)})}const y=document.getElementById("servicios-barberia-filter");y&&y.addEventListener("change",()=>{o()}),v()});