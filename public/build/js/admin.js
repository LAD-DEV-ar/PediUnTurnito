const SELECTORS={tabs:".admin-tab",sections:".admin-section",barberiasList:"#barberias-list",btnNewBarberia:"#btn-new-barberia",barberiaFormWrap:"#barberia-form-wrap",barberiaSave:"#barberia-save",barberiaCancel:"#barberia-cancel",barberiaId:"#barberia-id",barberiaNombre:"#barberia-nombre",barberiaLocalidad:"#barberia-localidad",barberiaCalle:"#barberia-calle",barberiaAltura:"#barberia-altura",serviciosList:"#servicios-list",serviciosFilter:"#servicios-barberia-filter",servicioFormWrap:"#servicio-form-wrap",btnNewServicio:"#btn-new-servicio",servicioSave:"#servicio-save",servicioCancel:"#servicio-cancel",servicioId:"#servicio-id",servicioBarberia:"#servicio-barberia",servicioNombre:"#servicio-nombre",servicioDuracion:"#servicio-duracion",servicioPrecio:"#servicio-precio",horariosList:"#horarios-list",horariosFilter:"#horarios-barberia-filter",btnNewHorario:"#btn-new-horario",horarioFormWrap:"#horario-form-wrap",horarioSave:"#horario-save",horarioCancel:"#horario-cancel",horarioId:"#horario-id",horarioBarberia:"#horario-barberia",horarioDia:"#horario-dia",horarioApertura:"#horario-apertura",horarioCierre:"#horario-cierre",horarioIntervalo:"#horario-intervalo",barberosList:"#barberos-list",barberosFilter:"#barberos-barberia-filter",btnNewBarbero:"#btn-new-barbero",barberoFormWrap:"#barbero-form-wrap",barberoSave:"#barbero-save",barberoCancel:"#barbero-cancel",barberoId:"#barbero-id",barberoBarberia:"#barbero-barberia",barberoNombre:"#barbero-nombre",barberoEmail:"#barbero-email",barberoTelefono:"#barbero-telefono",barberoPassword:"#barbero-password",turnosList:"#turnos-list",turnosFilterBarberia:"#turnos-barberia-filter",turnosFilterBarbero:"#turnos-barbero-filter",turnosFilterFecha:"#turnos-fecha-filter",turnosRefresh:"#turnos-refresh",citasList:"#citas-list",citaModal:"#cita-modal",citaModalBody:"#cita-modal-body",citaModalClose:"#cita-modal-close",citaModalClose2:"#cita-modal-close-2",citaModalBackdrop:"#cita-modal .modal-backdrop"},$=e=>document.querySelector(e),$$=e=>Array.from(document.querySelectorAll(e)),byId=e=>document.getElementById(e.replace("#","")),create=(e,r={})=>Object.assign(document.createElement(e),r);function escapeHtml(e){return null==e?"":String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function showLoading(e,r="Cargando..."){e&&(e.innerHTML=`<div class="muted">${escapeHtml(r)}</div>`)}function showEmpty(e,r="No hay registros."){e&&(e.innerHTML=`<div class="muted">${escapeHtml(r)}</div>`)}function showError(e,r="Error al cargar"){e&&(e.innerHTML=`<div class="muted">${escapeHtml(r)}</div>`)}const controllers={};function abortIfRunning(e){if(controllers[e])try{controllers[e].abort()}catch(e){}const r=new AbortController;return controllers[e]=r,r.signal}async function postJSON(e,r=new FormData,a){const o={method:"POST",body:r};a&&(o.signal=a);const t=await fetch(e,o);if(!t.ok){let e="";try{e=await t.text()}catch(e){}const r=new Error(`HTTP ${t.status} ${t.statusText} ${e?"- "+e:""}`);throw r.status=t.status,r}return await t.json()}function debounce(e,r=180){let a;return function(...o){clearTimeout(a),a=setTimeout(()=>e.apply(this,o),r)}}let barberosMap={};async function loadBarberias(){const e=document.querySelector(SELECTORS.barberiasList);if(!e)return;showLoading(e,"Cargando barberías...");const r=abortIfRunning("barberias");try{const a=(await postJSON("/admin/barberia/list",new FormData,r)).items||[];if(!a.length)return showEmpty(e,"No hay barberías.");e.innerHTML="",a.forEach(r=>{const a=create("div",{className:"item"});a.innerHTML=`<div style="flex:1"><strong>${escapeHtml(r.nombre)}</strong><div class="mini">${escapeHtml(r.localidad||"")} — ${escapeHtml((r.calle||"")+" "+(r.altura||""))}</div></div>\n        <div style="display:flex;gap:8px">\n          <button class="btn ghost btn-edit-barberia" data-id="${r.id}">Editar</button>\n          <button class="btn ghost btn-delete-barberia" data-id="${r.id}">Eliminar</button>\n        </div>`,e.appendChild(a)}),$$(".btn-edit-barberia").forEach(r=>r.addEventListener("click",a=>{const o=r.dataset.id;Array.from(e.querySelectorAll(".item"));postJSON("/admin/barberia/list",new FormData).then(e=>{const r=(e.items||[]).find(e=>String(e.id)===String(o));r&&showBarberiaForm(r)}).catch(e=>console.error("editBarberia fetch error",e))})),$$(".btn-delete-barberia").forEach(e=>e.addEventListener("click",async()=>{if(!confirm("Eliminar barbería?"))return;const r=new FormData;r.append("id",e.dataset.id);try{await postJSON("/admin/barberia/delete",r),await loadBarberias(),await populateBarberiaSelects()}catch(e){console.error("deleteBarberia error",e),alert("Error al eliminar barbería")}}))}catch(r){console.error("loadBarberias error",r),showError(e,"Error al cargar barberías")}}function showBarberiaForm(e=null){const r=document.querySelector(SELECTORS.barberiaFormWrap);r&&(r.style.display="block",byId("barberia-id").value=e?e.id:"",byId("barberia-nombre").value=e?e.nombre:"",byId("barberia-localidad").value=e?e.localidad:"",byId("barberia-calle").value=e?e.calle:"",byId("barberia-altura").value=e?e.altura:"",byId("barberia-form-title").innerText=e?"Editar barbería":"Nueva barbería")}async function saveBarberia(){const e=byId("barberia-id").value,r=byId("barberia-nombre").value.trim();if(!r)return alert("Nombre requerido");const a=new FormData;e&&a.append("id",e),a.append("nombre",r),a.append("localidad",byId("barberia-localidad").value.trim()),a.append("calle",byId("barberia-calle").value.trim()),a.append("altura",byId("barberia-altura").value.trim());try{await postJSON("/admin/barberia/save",a),document.querySelector(SELECTORS.barberiaFormWrap).style.display="none",await loadBarberias(),await populateBarberiaSelects()}catch(e){console.error("saveBarberia error",e),alert("Error al guardar barbería")}}async function loadServicios(){const e=document.querySelector(SELECTORS.serviciosList);if(!e)return;showLoading(e,"Cargando servicios...");const r=abortIfRunning("servicios"),a=new FormData,o=document.querySelector(SELECTORS.serviciosFilter)?.value||"";o&&a.append("id_barberia",o);try{const o=(await postJSON("/admin/servicio/list",a,r)).items||[];if(!o.length)return showEmpty(e,"No hay servicios.");e.innerHTML="",o.forEach(r=>{const a=create("div",{className:"item"});a.innerHTML=`<div style="flex:1"><strong>${escapeHtml(r.nombre)}</strong><div class="mini">${escapeHtml(String(r.duracion_min||r.duration_min||""))} min · $${escapeHtml(String(r.precio||r.price||""))}</div></div>\n        <div style="display:flex;gap:8px">\n          <button class="btn ghost btn-edit-servicio" data-id="${r.id}">Editar</button>\n          <button class="btn ghost btn-delete-servicio" data-id="${r.id}">Eliminar</button>\n        </div>`,e.appendChild(a)}),$$(".btn-edit-servicio").forEach(e=>e.addEventListener("click",r=>editServicio(e.dataset.id))),$$(".btn-delete-servicio").forEach(e=>e.addEventListener("click",async()=>{if(!confirm("Eliminar servicio?"))return;const r=new FormData;r.append("id",e.dataset.id);try{await postJSON("/admin/servicio/delete",r),await loadServicios()}catch(e){console.error("delete servicio",e),alert("Error al eliminar")}}))}catch(r){console.error("loadServicios error",r),showError(e,"Error al cargar servicios")}}async function editServicio(e){try{const r=((await postJSON("/admin/servicio/list",new FormData)).items||[]).find(r=>String(r.id)===String(e));if(!r)return alert("Servicio no encontrado");document.querySelector(SELECTORS.servicioFormWrap).style.display="block",byId("servicio-id").value=r.id,await populateBarberiaSelects(),setTimeout(()=>{byId("servicio-barberia").value=r.id_barberia||r.id_barberia||"",byId("servicio-nombre").value=r.nombre||r.name||"",byId("servicio-duracion").value=r.duracion_min||r.duration_min||"",byId("servicio-precio").value=r.precio||r.price||""},120)}catch(e){console.error("editServicio error",e),alert("Error al cargar servicio")}}async function saveServicio(){const e=byId("servicio-id").value,r=byId("servicio-barberia").value,a=byId("servicio-nombre").value.trim();if(!r)return alert("Seleccioná una barbería");if(!a)return alert("Nombre requerido");const o=new FormData;e&&o.append("id",e),o.append("id_barberia",r),o.append("nombre",a),o.append("duracion_min",String(parseInt(byId("servicio-duracion").value||0,10)||0)),o.append("precio",byId("servicio-precio").value||"0");try{await postJSON("/admin/servicio/save",o),document.querySelector(SELECTORS.servicioFormWrap).style.display="none",await loadServicios()}catch(e){console.error("saveServicio error",e),alert("Error al guardar servicio")}}async function loadHorarios(){const e=document.querySelector(SELECTORS.horariosList);if(!e)return;showLoading(e,"Cargando horarios...");const r=abortIfRunning("horarios"),a=new FormData,o=document.querySelector(SELECTORS.horariosFilter)?.value||"";o&&a.append("id_barberia",o);try{const o=(await postJSON("/admin/horario/list",a,r)).items||[];if(!o.length)return showEmpty(e,"No hay horarios registrados.");const t=["lunes","martes","miércoles","jueves","viernes","sábado","domingo"];o.sort((e,r)=>{const a=t.indexOf(e.dia_semana),o=t.indexOf(r.dia_semana);return a!==o?a-o:(e.hora_apertura||"").localeCompare(r.hora_apertura||"")}),e.innerHTML="",o.forEach(r=>{const a=(r.hora_apertura||"").substr(0,5),o=(r.hora_cierre||"").substr(0,5),t=r.intervalo_min||r.intervalo||"-",i=create("div",{className:"item"});i.innerHTML=`<div style="flex:1"><strong>${escapeHtml(r.dia_semana||"-")}</strong><div class="mini">${escapeHtml(a)} — ${escapeHtml(o)} · Intervalo: ${escapeHtml(String(t))} min</div></div>\n        <div style="display:flex;gap:8px">\n          <button class="btn ghost btn-edit-horario" data-id="${r.id}">Editar</button>\n          <button class="btn ghost btn-delete-horario" data-id="${r.id}">Eliminar</button>\n        </div>`,e.appendChild(i)}),$$(".btn-edit-horario").forEach(e=>e.addEventListener("click",()=>editHorario(e.dataset.id))),$$(".btn-delete-horario").forEach(e=>e.addEventListener("click",async()=>{if(!confirm("Eliminar horario?"))return;const r=new FormData;r.append("id",e.dataset.id);try{await postJSON("/admin/horario/delete",r),await loadHorarios()}catch(e){console.error("deleteHorario",e),alert("Error al eliminar horario")}}))}catch(r){console.error("loadHorarios error",r),showError(e,"Error al cargar horarios")}}async function editHorario(e){try{const r=((await postJSON("/admin/horario/list",new FormData)).items||[]).find(r=>String(r.id)===String(e));if(!r)return alert("Horario no encontrado");document.querySelector(SELECTORS.horarioFormWrap).style.display="block",byId("horario-id").value=r.id,await populateBarberiaSelects(),setTimeout(()=>{byId("horario-barberia").value=r.id_barberia||"",byId("horario-dia").value=r.dia_semana||"lunes",byId("horario-apertura").value=(r.hora_apertura||"").substr(0,5),byId("horario-cierre").value=(r.hora_cierre||"").substr(0,5),byId("horario-intervalo").value=r.intervalo_min||30},120)}catch(e){console.error("editHorario error",e),alert("Error al editar horario")}}async function saveHorario(){const e=byId("horario-id").value,r=byId("horario-barberia").value;if(!r)return alert("Seleccioná una barbería");const a=byId("horario-dia").value,o=byId("horario-apertura").value,t=byId("horario-cierre").value,i=parseInt(byId("horario-intervalo").value||30,10);if(!o||!t)return alert("Ingresá horas válidas");const n=new FormData;e&&n.append("id",e),n.append("id_barberia",r),n.append("dia_semana",a),n.append("hora_apertura",o),n.append("hora_cierre",t),n.append("intervalo_min",String(i));try{await postJSON("/admin/horario/save",n),document.querySelector(SELECTORS.horarioFormWrap).style.display="none",await loadHorarios()}catch(e){console.error("saveHorario error",e),alert("Error al guardar horario")}}async function loadBarberos(){const e=document.querySelector(SELECTORS.barberosList);if(!e)return;showLoading(e,"Cargando barberos...");const r=abortIfRunning("barberos"),a=new FormData,o=document.querySelector(SELECTORS.barberosFilter)?.value||"";o&&a.append("id_barberia",o);try{const o=(await postJSON("/admin/barbero/list",a,r)).items||[];if(!o.length)return showEmpty(e,"No hay barberos.");e.innerHTML="",barberosMap={},o.forEach(e=>{barberosMap[String(e.id)]=e}),o.forEach(r=>{const a=create("div",{className:"item"});a.innerHTML=`<div style="flex:1"><strong>${escapeHtml(r.nombre)}</strong><div class="mini">${escapeHtml(r.email||"")} · ${escapeHtml(r.telefono||"")}</div></div>\n        <div style="display:flex;gap:8px">\n          <button class="btn ghost btn-edit-barbero" data-id="${r.id}">Editar</button>\n          <button class="btn ghost btn-delete-barbero" data-id="${r.id}">Eliminar</button>\n        </div>`,e.appendChild(a)}),$$(".btn-edit-barbero").forEach(e=>e.addEventListener("click",()=>editBarbero(e.dataset.id))),$$(".btn-delete-barbero").forEach(e=>e.addEventListener("click",async()=>{if(!confirm("Eliminar barbero?"))return;const r=new FormData;r.append("id",e.dataset.id);try{await postJSON("/admin/barbero/delete",r),await loadBarberos()}catch(e){console.error("deleteBarbero",e),alert("Error al eliminar")}}))}catch(r){console.error("loadBarberos error",r),showError(e,"Error al cargar barberos")}}async function editBarbero(e){try{const r=((await postJSON("/admin/barbero/list",new FormData)).items||[]).find(r=>String(r.id)===String(e));if(!r)return alert("Barbero no encontrado");document.querySelector(SELECTORS.barberoFormWrap).style.display="block",await populateBarberiaSelects(),setTimeout(()=>{byId("barbero-id").value=r.id,byId("barbero-barberia").value=r.id_barberia||"",byId("barbero-nombre").value=r.nombre||"",byId("barbero-email").value=r.email||"",byId("barbero-telefono").value=r.telefono||""},120)}catch(e){console.error("editBarbero error",e),alert("Error al cargar barbero")}}async function saveBarbero(){const e=byId("barbero-id").value,r=byId("barbero-barberia").value,a=byId("barbero-nombre").value.trim(),o=byId("barbero-email").value.trim(),t=byId("barbero-telefono").value.trim(),i=byId("barbero-password").value.trim();if(!r)return alert("Seleccioná una barbería");if(!a||!o)return alert("Nombre y email son requeridos");const n=new FormData;e&&n.append("id",e),n.append("id_barberia",r),n.append("nombre",a),n.append("email",o),n.append("telefono",t),i&&n.append("password",i);try{await postJSON("/admin/barbero/save",n),document.querySelector(SELECTORS.barberoFormWrap).style.display="none",await loadBarberos()}catch(e){console.error("saveBarbero error",e),alert("Error al guardar barbero")}}async function loadTurnos(){const e=document.querySelector(SELECTORS.turnosList);if(!e)return;showLoading(e,"Cargando turnos...");const r=abortIfRunning("turnos"),a=new FormData,o=document.querySelector(SELECTORS.turnosFilterBarberia)?.value||"",t=document.querySelector(SELECTORS.turnosFilterBarbero)?.value||"",i=document.querySelector(SELECTORS.turnosFilterFecha)?.value||"";o&&a.append("id_barberia",o),t&&a.append("id_barbero",t),i&&a.append("fecha",i);try{await populateBarberoSelects(o);const t=(await postJSON("/admin/turnos/list",a,r)).items||[];if(!t.length)return showEmpty(e,"No hay turnos.");t.sort((e,r)=>e.fecha!==r.fecha?(r.fecha||"").localeCompare(e.fecha||""):(e.hora_inicio||"").localeCompare(r.hora_inicio||"")),e.innerHTML="",t.forEach(r=>{const a=barberosMap[String(r.id_barbero)]||null,o=a?a.nombre||a.name:r.barbero_nombre||r.barbero||String(r.id_barbero),t=(r.hora_inicio||"").substr(0,5),i=((r.hora_fin||"").substr(0,5),create("div",{className:"item"}));i.innerHTML=`<div style="flex:1">\n        <strong>${escapeHtml(r.fecha||"")} ${escapeHtml(t)}</strong>\n        <div class="mini">Barbero: ${escapeHtml(o)} · Estado: ${escapeHtml(r.estado||"-")}</div>\n      </div>\n      <div style="display:flex;gap:8px">\n        ${"reservado"===r.estado?`<button class="btn ghost btn-view-cita" data-turno="${r.id}">Ver cita</button>`:""}\n      </div>`,e.appendChild(i)}),$$(".btn-view-cita").forEach(e=>e.addEventListener("click",e=>{fetchCitaByTurno(e.currentTarget.dataset.turno)}))}catch(r){console.error("loadTurnos error",r),showError(e,"Error al cargar turnos")}}async function loadCitas(){const e=document.querySelector(SELECTORS.citasList);if(e){showLoading(e,"Cargando citas...");try{const r=(await postJSON("/admin/cita/list",new FormData)).items||[];if(!r.length)return showEmpty(e,"No hay citas.");renderCitas(r)}catch(e){console.error("loadCitas error",e),showError(document.querySelector(SELECTORS.citasList),"Error al cargar citas")}}}function renderCitas(e){const r=document.querySelector(SELECTORS.citasList);r&&(r.innerHTML="",e.forEach(e=>{const a=e.servicio_nombre||e.servicio||e.servicioName||e.servicio_nombre_servicio||e.servicio_nombre||e.servicio_nombre||e.servicio||e.servicio_producto||e.servicio_nombre,o=e.cliente_nombre||e.cliente||e.nombre_cliente||e.clienteName||e.cliente_nombre,t=e.fecha||e.fecha_turno||(e.fecha_creado?e.fecha_creado:""),i=(e.hora_inicio||e.hora||"").substr(0,5),n=e.id_turno||e.idTurno||e.turno_id||e.id_turno,c=e.id||e.cita_id||e.id_cita,s=create("div",{className:"item"});s.innerHTML=`<div style="flex:1">\n      <strong>${escapeHtml(a||"Servicio")}</strong>\n      <div class="mini">${escapeHtml(o||"—")} — ${escapeHtml(t)} ${escapeHtml(i)}</div>\n    </div>\n    <div style="display:flex;gap:8px">\n      <button class="btn ghost btn-view-cita" data-turno="${escapeHtml(n||"")}" data-cita="${escapeHtml(c||"")}">Ver</button>\n      <button class="btn ghost btn-cancel-cita" data-id="${escapeHtml(c||"")}">Cancelar</button>\n    </div>`,r.appendChild(s)}),$$(".btn-view-cita").forEach(e=>e.addEventListener("click",e=>{const r=e.currentTarget.dataset.turno||"",a=e.currentTarget.dataset.cita||"";r?fetchCitaByTurno(r):a?fetchCitaById(a):alert("No hay identificador válido para la cita")})),$$(".btn-cancel-cita").forEach(e=>e.addEventListener("click",async e=>{const r=e.currentTarget.dataset.id;if(!r)return alert("ID inválido");if(!confirm("Cancelar cita?"))return;const a=new FormData;a.append("id",r);try{await postJSON("/admin/cita/cancel",a),await loadCitas(),await loadTurnos()}catch(e){console.error("cancelCita error",e),alert("Error al cancelar cita")}})))}function _safeText(e){return null==e||""===e?"—":String(e)}function _formatDate(e){if(!e)return"";const r=String(e).split("-");return 3===r.length?`${r[2]}/${r[1]}/${r[0]}`:e}function _formatTime(e){return e?String(e).substr(0,5):""}function openCitaModalFromObject(e){const r=document.querySelector("#cita-modal"),a=document.querySelector("#cita-modal-body"),o=document.querySelector("#cita-modal-title"),t=document.querySelector("#cita-modal-subtitle");if(!(r&&a&&o&&t))return void console.error("Modal de cita: elementos DOM no encontrados");if(!e||0===Object.keys(e).length)return o.textContent="Detalle de la cita",t.textContent="No hay información disponible",a.innerHTML='<div class="muted">La información de la cita no está disponible. Reintentá luego.</div>',r.style.display="flex",void r.setAttribute("aria-hidden","false");const i=e.servicio_nombre||e.servicio||e.nombre_servicio||e.servicioName||e.servicio_name||_safeText(e.servicio_nombre),n=e.cliente_nombre||e.cliente||e.nombre_cliente||e.clienteName||_safeText(e.cliente_nombre),c=e.cliente_email||e.email||e.clienteEmail||"",s=e.cliente_telefono||e.telefono||e.clienteTelefono||"",l=e.barbero_nombre||e.barbero||e.barberoName||"",d=e.fecha||e.fecha_turno||e.fecha_cita||"",b=e.hora_inicio||e.hora||e.hora_inicio_turno||"",u=e.hora_fin||e.hora_fin_turno||"",m=e.servicio_precio||e.precio||e.price||"";o.textContent=i?`Cita: ${i}`:"Detalle de la cita",t.textContent=`${l?"Barbero: "+l+" · ":""}${_formatDate(d)} ${_formatTime(b)}`,a.innerHTML=`\n      <div style="display:grid;grid-template-columns:1fr;gap:8px">\n        <div><strong>Cliente:</strong> ${escapeHtml(n||"—")}</div>\n        <div><strong>Email:</strong> ${escapeHtml(c||"—")}</div>\n        <div><strong>Teléfono:</strong> ${escapeHtml(s||"—")}</div>\n        <hr />\n        <div><strong>Servicio:</strong> ${escapeHtml(i||"—")}</div>\n        <div><strong>Precio:</strong> $${escapeHtml(String(m||"—"))}</div>\n        <div><strong>Barbero:</strong> ${escapeHtml(l||"—")}</div>\n        <div><strong>Fecha / Hora:</strong> ${escapeHtml(_formatDate(d))} ${escapeHtml(_formatTime(b))} — ${escapeHtml(_formatTime(u))}</div>\n        <div><strong>ID cita:</strong> ${escapeHtml(String(e.id||e.cita_id||"—"))} — <strong>ID turno:</strong> ${escapeHtml(String(e.id_turno||e.turno_id||"—"))}</div>\n      </div>\n    `,r.style.display="flex",r.setAttribute("aria-hidden","false")}function closeCitaModal(){const e=document.querySelector("#cita-modal");e&&(e.style.display="none",e.setAttribute("aria-hidden","true"))}async function fetchCitaByTurno(e){const r=document.querySelector("#cita-modal"),a=document.querySelector("#cita-modal-body");r&&a&&(r.style.display="flex",r.setAttribute("aria-hidden","false"),a.innerHTML='<div class="muted">Cargando cita…</div>',document.querySelector("#cita-modal-subtitle").textContent="Cargando…");try{const r=new FormData;r.append("id_turno",e);const a=await postJSON("/admin/cita/get",r);if(a&&a.item)return void openCitaModalFromObject(a.item);if(a&&a.items&&a.items.length)return void openCitaModalFromObject(a.items[0]);openCitaModalFromObject(null)}catch(e){console.error("fetchCitaByTurno error",e),a&&(a.innerHTML=`<div class="muted">Error al solicitar la cita: ${escapeHtml(e.message||"")}</div>`)}}async function fetchCitaById(e){const r=document.querySelector("#cita-modal"),a=document.querySelector("#cita-modal-body");r&&a&&(r.style.display="flex",r.setAttribute("aria-hidden","false"),a.innerHTML='<div class="muted">Cargando cita…</div>',document.querySelector("#cita-modal-subtitle").textContent="Cargando…");try{const r=new FormData;r.append("id",e);const a=await postJSON("/admin/cita/get",r);a&&a.item?openCitaModalFromObject(a.item):openCitaModalFromObject(null)}catch(e){console.error("fetchCitaById error",e),a&&(a.innerHTML=`<div class="muted">Error al solicitar la cita: ${escapeHtml(e.message||"")}</div>`)}}async function populateBarberiaSelects(){const e=new FormData;try{const r=(await postJSON("/admin/barberia/list",e)).items||[];[SELECTORS.servicioBarberia,SELECTORS.serviciosFilter,SELECTORS.horarioBarberia,SELECTORS.horariosFilter,SELECTORS.barberoBarberia,SELECTORS.barberosFilter,SELECTORS.turnosFilterBarberia].forEach(e=>{const a=document.querySelector(e);if(!a)return;const o=e===SELECTORS.serviciosFilter?"Todas las barberías":"Seleccione";a.innerHTML=`<option value="">${o}</option>`,r.forEach(e=>{const r=create("option");r.value=e.id,r.textContent=e.nombre,a.appendChild(r)})});const a=document.querySelector(SELECTORS.turnosFilterBarberia)?.value||"";await populateBarberoSelects(a)}catch(e){console.error("populateBarberiaSelects error",e)}}async function populateBarberoSelects(e=""){const r=[SELECTORS.turnosFilterBarbero],a=new FormData;e&&a.append("id_barberia",e);try{const e=(await postJSON("/admin/barbero/list",a)).items||[];barberosMap={},e.forEach(e=>{barberosMap[String(e.id)]=e}),r.forEach(r=>{const a=document.querySelector(r);a&&(a.innerHTML='<option value="">Barbero</option>',e.forEach(e=>{const r=create("option");r.value=e.id,r.textContent=e.nombre,a.appendChild(r)}))})}catch(e){console.error("populateBarberoSelects error",e)}}document.addEventListener("DOMContentLoaded",()=>{$$(SELECTORS.tabs).forEach(e=>{e.addEventListener("click",()=>{const r=e.dataset.tab;$$(SELECTORS.sections).forEach(e=>e.style.display="none");const a=document.getElementById(`tab-${r}`);a&&(a.style.display="block"),$$(SELECTORS.tabs).forEach(e=>e.classList.remove("active")),e.classList.add("active"),"barberias"===r&&loadBarberias(),"servicios"===r&&loadServicios(),"horarios"===r&&loadHorarios(),"barberos"===r&&loadBarberos(),"turnos"===r&&loadTurnos(),"citas"===r&&loadCitas()})}),(document.querySelector(SELECTORS.tabs)||{click:()=>{}}).click(),populateBarberiaSelects(),document.querySelector(SELECTORS.citaModalClose)?.addEventListener("click",closeCitaModal),document.querySelector(SELECTORS.citaModalClose2)?.addEventListener("click",closeCitaModal),document.querySelector(SELECTORS.citaModalBackdrop)?.addEventListener("click",closeCitaModal),document.querySelector(SELECTORS.btnNewBarberia)?.addEventListener("click",()=>showBarberiaForm()),document.querySelector(SELECTORS.barberiaCancel)?.addEventListener("click",()=>{document.querySelector(SELECTORS.barberiaFormWrap).style.display="none"}),document.querySelector(SELECTORS.barberiaSave)?.addEventListener("click",saveBarberia),document.querySelector(SELECTORS.btnNewServicio)?.addEventListener("click",()=>{document.querySelector(SELECTORS.servicioFormWrap).style.display="block",byId("servicio-id").value="",byId("servicio-nombre").value="",byId("servicio-duracion").value="",byId("servicio-precio").value="",populateBarberiaSelects()}),document.querySelector(SELECTORS.servicioCancel)?.addEventListener("click",()=>{document.querySelector(SELECTORS.servicioFormWrap).style.display="none"}),document.querySelector(SELECTORS.servicioSave)?.addEventListener("click",saveServicio),document.querySelector(SELECTORS.serviciosFilter)?.addEventListener("change",debounce(loadServicios,150)),document.querySelector(SELECTORS.btnNewHorario)?.addEventListener("click",()=>{document.querySelector(SELECTORS.horarioFormWrap).style.display="block",byId("horario-id").value="",byId("horario-intervalo").value="30",populateBarberiaSelects()}),document.querySelector(SELECTORS.horarioCancel)?.addEventListener("click",()=>{document.querySelector(SELECTORS.horarioFormWrap).style.display="none"}),document.querySelector(SELECTORS.horarioSave)?.addEventListener("click",saveHorario),document.querySelector(SELECTORS.horariosFilter)?.addEventListener("change",debounce(()=>{populateBarberoSelects(document.querySelector(SELECTORS.horariosFilter).value||""),loadHorarios()},160)),document.querySelector(SELECTORS.btnNewBarbero)?.addEventListener("click",()=>{document.querySelector(SELECTORS.barberoFormWrap).style.display="block",byId("barbero-id").value="",byId("barbero-password").value="",populateBarberiaSelects()}),document.querySelector(SELECTORS.barberoCancel)?.addEventListener("click",()=>{document.querySelector(SELECTORS.barberoFormWrap).style.display="none"}),document.querySelector(SELECTORS.barberoSave)?.addEventListener("click",saveBarbero),document.querySelector(SELECTORS.barberosFilter)?.addEventListener("change",debounce(loadBarberos,150)),document.querySelector(SELECTORS.turnosFilterBarberia)?.addEventListener("change",()=>{populateBarberoSelects(document.querySelector(SELECTORS.turnosFilterBarberia).value||""),loadTurnos()}),document.querySelector(SELECTORS.turnosFilterBarbero)?.addEventListener("change",debounce(loadTurnos,120)),document.querySelector(SELECTORS.turnosFilterFecha)?.addEventListener("change",debounce(loadTurnos,120)),document.querySelector(SELECTORS.turnosRefresh)?.addEventListener("click",loadTurnos);const e=document.querySelector(`${SELECTORS.tabs}.active`)||document.querySelector(SELECTORS.tabs);if(e){const r=e.dataset.tab;"barberias"===r&&loadBarberias(),"servicios"===r&&loadServicios(),"horarios"===r&&loadHorarios(),"barberos"===r&&loadBarberos(),"turnos"===r&&loadTurnos(),"citas"===r&&loadCitas()}}),document.querySelector("#cita-modal-close")?.addEventListener("click",closeCitaModal),document.querySelector("#cita-modal-close-2")?.addEventListener("click",closeCitaModal),document.querySelector("#cita-modal .modal-backdrop")?.addEventListener("click",closeCitaModal);